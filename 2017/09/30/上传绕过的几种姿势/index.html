<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 上传绕过的几种姿势 · Damit5's Blog</title><meta name="description" content="纸上得来终觉浅，绝知此事要躬行。"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/jekyll.css"><!--[if lt IE 9]>
<script src="js/html5shiv.min.js"></script>
<script src="js/respond.min.js"></script>
<![endif]--></head><body><header class="row-flex-row limit-width vh-center"><a href="/" class="logo"><img src="/favicon.png"></a><nav><ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-link">主页</a></li><li class="nav-list-item"><a href="/archives/" class="nav-link active">   博客</a></li><li class="nav-list-item"><a href="http://damit5.kiwi/AboutMe/" target="_blank" class="nav-link">关于我</a></li><li class="nav-list-item"><a href="http://damit5.kiwi/Link/" target="_blank" class="nav-link">友情链接</a></li><li class="nav-list-item"><a href="https://github.com/damit5" target="_blank" class="nav-link">github</a></li><li class="nav-list-item"><a href="mailto:damit5@protonmail.com" target="_blank" class="nav-link">email</a></li><li class="nav-list-item"><a href="/atom.xml" class="nav-link">rss</a></li></ul></nav></header><div class="container limit-width"><section class="row-flex-row"><div class="post"><article class="post-block"><h2 class="post-title"><a href="/2017/09/30/上传绕过的几种姿势/" class="post-title-link">上传绕过的几种姿势</a></h2><div class="post-meta"><ul class="post-tag-list"><li class="post-tag-item"><a href="/tags/渗透测试/" class="post-tag-link">渗透测试</a></li></ul><div class="post-time">2017年9月30日 星期六</div></div><div class="post-content"><script src="/assets/js/APlayer.min.js"> </script><a id="more"></a>
<h2 id="0x01-前台脚本检测扩展名—绕过"><a href="#0x01-前台脚本检测扩展名—绕过" class="headerlink" title="0x01: 前台脚本检测扩展名—绕过"></a>0x01: 前台脚本检测扩展名—绕过</h2><h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>当用户在客户端选择文件点击上传的时候，客户端还没有向服务器发送任何消息，就对本地文件进行检测来判断是否是可以上传的类型，这种方式称为前台脚本检测扩展名。</p>
<h4 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>绕过前台脚本检测扩展名，就是将所要上传文件的扩展名更改为符合脚本检测规则的扩展名，通过BurpSuite工具，截取数据包，并将数据包中文件扩展名更改回原来的，达到绕过的目的。</p>
<p>例如:文件名本来为【evil.jpg】，上传时，用BurpSuite截包后，将数据包中的名字改为【evil.php】(或其它脚本类型)即可。</p>
<h2 id="0x02-Content-Type检测文件类型—绕过"><a href="#0x02-Content-Type检测文件类型—绕过" class="headerlink" title="0x02: Content-Type检测文件类型—绕过"></a>0x02: Content-Type检测文件类型—绕过</h2><h4 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a>原理</h4><p>当浏览器在上传文件到服务器的时候，服务器对说上传文件的Content-Type类型进行检测，如果是白名单允许的，则可以正常上传，否则上传失败。</p>
<h4 id="绕过方法-1"><a href="#绕过方法-1" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>绕过Content–Type文件类型检测，就是用BurpSuite截取并修改数据包中文件的Content-Type类型(如改为:image/gif)，使其符合白名单的规则，达到上传的目的。</p>
<h2 id="0x03-文件系统00截断—绕过"><a href="#0x03-文件系统00截断—绕过" class="headerlink" title="0x03: 文件系统00截断—绕过"></a>0x03: 文件系统00截断—绕过</h2><h4 id="原理-2"><a href="#原理-2" class="headerlink" title="原理"></a>原理</h4><p>在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束。利用00截断就是利用程序员在写程序时对文件的上传路径过滤不严格，产生0x00上传截断漏洞。</p>
<h4 id="绕过方法-2"><a href="#绕过方法-2" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>通过抓包截断将【evil.php.jpg】后面的一个【.】换成【0x00】。在上传的时候，当文件系统读到【0x00】时，会认为文件已经结束，从而将【evil.php.jpg】的内容写入到【evil.php】中，从而达到攻击的目的。</p>
<h2 id="0x04-服务器端扩展名检测黑名单—绕过"><a href="#0x04-服务器端扩展名检测黑名单—绕过" class="headerlink" title="0x04: 服务器端扩展名检测黑名单—绕过"></a>0x04: 服务器端扩展名检测黑名单—绕过</h2><h4 id="原理-3"><a href="#原理-3" class="headerlink" title="原理"></a>原理</h4><p>当浏览器将文件提交到服务器端的时候，服务器端会根据设定的黑白名单对浏览器提交上来的文件扩展名进行检测，如果上传的文件扩展名不符合黑白名单的限制，则不予上传，否则上传成功。</p>
<h4 id="绕过方法-3"><a href="#绕过方法-3" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>将一句话木马的文件名【evil.php】，改成【evil.php.abc】(奇怪的不被解析的后缀名都行)。首先，服务器验证文件扩展名的时候，验证的是【.abc】，只要该扩展名符合服务器端黑白名单规则，即可上传。另外，当在浏览器端访问该文件时，Apache如果解析不了【.abc】扩展名，会向前寻找可解析的扩展名，即【.php】</p>
<h2 id="0x05-JS检测上传文件—绕过"><a href="#0x05-JS检测上传文件—绕过" class="headerlink" title="0x05: JS检测上传文件—绕过"></a>0x05: JS检测上传文件—绕过</h2><h4 id="原理-4"><a href="#原理-4" class="headerlink" title="原理"></a>原理</h4><p>上传文件时，对方使用JavaScript语句语法检测上传文件的合法性问题。</p>
<h4 id="绕过方法-4"><a href="#绕过方法-4" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>在本地浏览器客户端禁用JS即可。可使用火狐浏览器的NoScript插件、IE中禁用掉JS等方式实现。</p>
<h2 id="0x06-重写解析规则—绕过"><a href="#0x06-重写解析规则—绕过" class="headerlink" title="0x06: 重写解析规则—绕过"></a>0x06: 重写解析规则—绕过</h2><h4 id="原理-5"><a href="#原理-5" class="headerlink" title="原理"></a>原理</h4><p>上传覆盖.htaccess文件，重写解析规则，将上传的带有脚本马的图片以脚本方式解析。</p>
<h4 id="绕过方法-5"><a href="#绕过方法-5" class="headerlink" title="绕过方法"></a>绕过方法</h4><p>在可以上传.htaccess文件时，先上传.htaccess文件，覆盖掉原先的.htaccess文件；再上传【evil.gif】文件。使用如下的.htaccess语句，即可将【evil.gif】文件以php脚本方式解析。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;FilesMatch &quot;evil.gif&quot;&gt;</div><div class="line">SetHandler application/x-httpd-php</div><div class="line">&lt;/FilesMatch&gt;</div></pre></td></tr></table></figure></p>
<h2 id="0x07-其它方式—绕过"><a href="#0x07-其它方式—绕过" class="headerlink" title="0x07: 其它方式—绕过"></a>0x07: 其它方式—绕过</h2><h4 id="原理-6"><a href="#原理-6" class="headerlink" title="原理"></a>原理</h4><p>部分程序员的思维不严谨，并使用逻辑不完善的上传文件合法性检测手段，导致可以找到方式绕过其检测方式。</p>
<h4 id="绕过方法-6"><a href="#绕过方法-6" class="headerlink" title="绕过方法"></a>绕过方法</h4><ol>
<li><p>后缀名大小写绕过<br>用于只将小写的脚本后缀名(如php)过滤掉的场合；<br>例如:将Burpsuite截获的数据包中的文件名【evil.php】改为【evil.Php】</p>
</li>
<li><p>双写后缀名绕过<br>用于只将文件后缀名，例如”php”字符串过滤的场合；<br>例如:上传时将Burpsuite截获的数据包中文件名【evil.php】改为【evil.pphphp】，那么过滤了第一个”php”字符串”后，开头的’p’和结尾的’hp’就组合又形成了【php】。</p>
</li>
<li><p>特殊后缀名绕过<br>用于检测文件合法性的脚本有问题的场合；<br>例如:将Burpsuite截获的数据包中【evil.php】名字改为【evil.php6】，或加个空格改为【evil.php 】等。</p>
</li>
</ol>
<div id="aplayer7" class="aplayer" style="margin-bottom: 20px;"></div>
		<script>
			new APlayer({
				element: document.getElementById("aplayer7"),
				narrow: false,
				autoplay: true,
				showlrc: 0,
				music: {
					title: "六月的雨",
					author: "胡歌",
					url: "http://damit5.kiwi/Music/%E5%85%AD%E6%9C%88%E7%9A%84%E9%9B%A8-%E8%83%A1%E6%AD%8C.mp3",
					pic: "http://damit5.kiwi/Music/233.jpg",
				}
			});
		</script>
</div></article><div class="pagination"><a href="/2017/09/30/MySQL-PHP手工联合查询注入/" class="pagination-prev">PREV</a><a href="/2017/09/30/Hello-World/" class="pagination-next">NEXT</a></div><div class="comments"></div></div><aside class="sidebar"><h3>分类标签</h3><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Metasploit-Framework/">Metasploit-Framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python/">Python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/其他/">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/权限维持/">权限维持</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/渗透测试/">渗透测试</a></li></ul><h3>最新文章</h3><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/10/15/XSS-绕过常用语句/">XSS 绕过常用语句</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/Windows-MySQL-的安装/">Windows MySQL 的安装</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/利用Python-Selenium库模拟登陆/">利用Python Selenium库模拟登陆</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/Windows-Shift-后门/">Windows Shift 后门</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/Python-socket模块实现简易的通信/">Python socket模块实现简易的通信</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/Python-argparse-模块的简易使用/">Python argparse 模块的简易使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/MSFvenom使用总结/">MSFvenom使用总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/30/Meterpreter-常用命令和后渗透/">Meterpreter 常用命令和后渗透</a></li></ul></aside></section></div><div class="extra"></div><footer class="footer"><div class="row-flex-row limit-width vh-center"><div class="copyright"><P>© 2017 <a href="/">Damit 5</P></div><div class="power"><p><a href="http://pinggod.com/">Sean Sun</a>, 
<a href="https://hexo.io">Hexo</a>, 
<a href="https://github.com/">GitHub</a>, 
<a href="https://jekyllrb.com/">Jekyll</a></p></div></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-80781234-1",'auto');ga('send','pageview');</script><script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "//hm.baidu.com/hm.js?ee75cf111111aa99f8540efa2570970";var s = document.getElementsByTagName("script")[0]; s.parentNode.insertBefore(hm, s);})();</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>